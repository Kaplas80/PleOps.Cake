trigger:
  branches:
    include:
    - develop
    - refs/pull/*
  tags:
    include:
      - v*

variables:
  buildConfiguration: 'Release'
  netCoreSdk: '3.1.401'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 'true'
  DOTNET_CLI_TELEMETRY_OPTOUT: 'true'

jobs:
  - job: 'build_lin'
    displayName: "Build"
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - task: UseDotNet@2
        displayName: "Get .NET SDK"
        inputs:
          packageType: 'sdk'
          version: '$(netCoreSdk)'

      - script: |
          dotnet tool restore
          dotnet cake --bootstrap
        displayName: "Install build tools"

      - script: dotnet cake --target=Stage-Artifacts --configuration=$(buildConfiguration) --artifacts=$(Build.ArtifactStagingDirectory)
        displayName: "Build and stage artifacts"

      - task: PublishBuildArtifacts@1
        displayName: "Publish artifacts"
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)'
          ArtifactName: 'artifacts'
          publishLocation: 'Container'

  - job: 'preview_release'
    displayName: 'Publish preview release'
    pool:
      vmImage: 'ubuntu-latest'
    dependsOn: ['build_lin']
    condition: "and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))"
    steps:
      - task: DownloadBuildArtifacts@0
        displayName: 'Get build artifacts'
        inputs:
          buildType: 'current'
          downloadType: 'single'
          artifactName: 'artifacts'
          downloadPath: '$(Build.ArtifactStagingDirectory)'

      - task: DotNetCoreCLI@2
        displayName: 'Push NuGet to feed'
        inputs:
          command: 'push'
          packagesToPush: '$(Build.ArtifactStagingDirectory)/**/*.nupkg'
          nuGetFeedType: 'internal'
          publishVstsFeed: '339c91a8-9d6c-4082-8b1a-93c2ae76b637/f434f007-6349-4876-9d16-e00ec2460ec0'
